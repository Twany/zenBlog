---
import Icon from "../Icon.astro";
import {uiLabels} from "../../data/uiLabels";
import {formatDate} from "../../utils/date";
import {
	getBlogIndexUrl,
	getBlogPostUrl,
	getSlugFromEntry,
} from "../../utils/blog";
import type {BlogEntry} from "../../utils/blog";
import type {Locale} from "../../utils/i18n";

interface Props {
	entry: BlogEntry;
	lang: Locale;
	posts: BlogEntry[];
}

const {entry, lang, posts} = Astro.props as Props;
const {Content, headings} = await entry.render();
const tocItems = headings.filter(
	(heading) => heading.depth === 2 || heading.depth === 3
);

const currentIndex = posts.findIndex((post) => post.id === entry.id);
const prevPost =
	currentIndex < posts.length - 1 ? posts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? posts[currentIndex - 1] : null;

const relatedPosts = (
	entry.data.tags
		? posts.filter(
				(post) =>
					post.id !== entry.id &&
					post.data.tags?.some((tag) =>
						entry.data.tags?.includes(tag)
					)
			)
		: []
).slice(0, 2);
---

<div
	class="fixed top-0 left-0 h-1 bg-brand-cyan z-[60] transition-all duration-150"
	data-reading-progress
>
</div>

<div class="max-w-7xl mx-auto px-6 animate-fade-in pb-20">
	<a
		href={getBlogIndexUrl(lang)}
		class="group flex items-center gap-2 text-gray-400 hover:text-brand-cyan transition-colors mb-8 font-sans font-bold uppercase tracking-widest text-sm"
	>
		<div
			class="p-1 rounded-full border border-gray-200 group-hover:border-brand-cyan transition-colors"
		>
			<Icon name="arrow-left" size={16} />
		</div>
		{uiLabels.common.backToBlog[lang]}
	</a>

	<header class="mb-12 border-b-4 border-brand-cyan pb-12 max-w-4xl">
		<div
			class="flex flex-col md:flex-row md:items-center gap-4 text-sm font-bold tracking-widest text-gray-400 uppercase mb-6"
		>
			<span
				class="bg-brand-cyan/10 text-brand-cyan px-3 py-1 rounded w-fit"
				>{entry.data.category}</span
			>
			<div class="flex items-center gap-4">
				<span class="flex items-center gap-1"
					><Icon name="calendar" size={14} />{
						formatDate(entry.data.pubDate, lang)
					}</span
				>
				<span class="flex items-center gap-1"
					><Icon name="clock" size={14} />{entry.data.readTime}</span
				>
			</div>
		</div>

		<h1
			class="font-display font-bold text-3xl md:text-4xl lg:text-5xl text-brand-dark leading-tight mb-6"
		>
			{entry.data.title}
		</h1>

		{
			entry.data.tags?.length ? (
				<div class="flex flex-wrap items-center gap-2">
					<Icon name="tag" size={16} class="text-gray-300" />
					{entry.data.tags.map((tag) => (
						<span class="text-xs font-bold uppercase tracking-wider text-gray-500 bg-gray-100 px-2 py-1 rounded-full border border-gray-200">
							{tag}
						</span>
					))}
				</div>
			) : null
		}
	</header>

	<div class="grid grid-cols-1 lg:grid-cols-12 gap-12 relative">
		<div class="lg:col-span-8">
			{
				tocItems.length ? (
					<div class="lg:hidden mb-8 border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
						<button
							type="button"
							class="w-full flex items-center justify-between p-4 bg-white border-b border-gray-200 font-display font-bold text-brand-dark"
							data-toc-toggle
						>
							<span class="flex items-center gap-2 uppercase tracking-wider">
								<Icon name="list" size={18} />{" "}
								{uiLabels.blog.tableOfContents[lang]}
							</span>
							<span data-toc-icon>
								<Icon name="chevron-down" size={18} />
							</span>
						</button>
						<nav class="p-4 space-y-2 hidden" data-toc-panel>
							{tocItems.map((item) => (
								<button
									type="button"
									class={`block text-left text-sm py-1 transition-colors w-full ${
										item.depth === 3 ? "pl-4" : ""
									} text-gray-600`}
									data-toc-link={item.slug}
								>
									{item.text}
								</button>
							))}
						</nav>
					</div>
				) : null
			}

			<div
				class="prose prose-sm md:prose-base max-w-none font-serif text-gray-700"
			>
				<Content />
			</div>

			<div
				class="mt-20 pt-12 border-t border-gray-200 flex items-center gap-6"
			>
				<div
					class="w-16 h-16 bg-brand-dark rounded-full flex items-center justify-center text-white font-display font-bold text-2xl"
				>
					M
				</div>
				<div>
					<p class="font-display font-bold text-lg text-brand-dark">
						Twany
					</p>
					<p class="font-serif text-gray-500 italic">
						Writing about the web since 2004.
					</p>
				</div>
			</div>

			<div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-4">
				{
					prevPost ? (
						<a
							href={getBlogPostUrl(
								lang,
								getSlugFromEntry(prevPost)
							)}
							class="group border border-gray-200 p-6 rounded-lg text-left hover:border-brand-cyan transition-all bg-slate-50 hover:bg-white hover:shadow-md"
						>
							<span class="text-xs font-bold uppercase tracking-widest text-gray-400 block mb-2 group-hover:text-brand-cyan">
								{uiLabels.blog.previousArticle[lang]}
							</span>
							<span class="font-display font-bold text-lg text-brand-dark group-hover:text-brand-cyan transition-colors">
								{prevPost.data.title}
							</span>
						</a>
					) : (
						<div />
					)
				}

				{
					nextPost ? (
						<a
							href={getBlogPostUrl(
								lang,
								getSlugFromEntry(nextPost)
							)}
							class="group border border-gray-200 p-6 rounded-lg text-right hover:border-brand-cyan transition-all bg-slate-50 hover:bg-white hover:shadow-md"
						>
							<span class="text-xs font-bold uppercase tracking-widest text-gray-400 block mb-2 group-hover:text-brand-cyan">
								{uiLabels.blog.nextArticle[lang]}
							</span>
							<span class="font-display font-bold text-lg text-brand-dark group-hover:text-brand-cyan transition-colors">
								{nextPost.data.title}
							</span>
						</a>
					) : (
						<div />
					)
				}
			</div>

			{
				relatedPosts.length ? (
					<div class="mt-20">
						<h3 class="font-display font-bold text-2xl uppercase text-brand-dark mb-8 border-b border-gray-200 pb-4">
							{uiLabels.blog.relatedPosts[lang]}
						</h3>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
							{relatedPosts.map((post) => (
								<a
									href={getBlogPostUrl(
										lang,
										getSlugFromEntry(post)
									)}
									class="group"
								>
									<div class="text-xs font-bold uppercase tracking-widest text-brand-cyan mb-2">
										{post.data.category}
									</div>
									<h4 class="font-display font-bold text-xl text-brand-dark group-hover:text-brand-cyan transition-colors mb-2">
										{post.data.title}
									</h4>
									<p class="font-serif text-gray-500 text-sm line-clamp-2">
										{post.data.description}
									</p>
								</a>
							))}
						</div>
					</div>
				) : null
			}
		</div>

		<aside class="hidden lg:block lg:col-span-4 relative">
			<div class="sticky top-32">
				{
					tocItems.length ? (
						<div>
							<h4 class="font-display font-bold text-sm uppercase tracking-widest text-gray-400 mb-6 flex items-center gap-2">
								<Icon name="list" size={16} />{" "}
								{uiLabels.blog.tableOfContents[lang]}
							</h4>
							<nav class="relative border-l-2 border-gray-100">
								{tocItems.map((item) => (
									<button
										type="button"
										class={`block text-left text-sm py-2 pl-4 -ml-[2px] border-l-2 transition-all w-full hover:text-brand-dark ${
											item.depth === 3 ? "ml-4" : ""
										} border-transparent text-gray-500`}
										data-toc-link={item.slug}
									>
										{item.text}
									</button>
								))}
							</nav>
						</div>
					) : null
				}
			</div>
		</aside>
	</div>
</div>

<script is:inline>
	const progressBar = document.querySelector("[data-reading-progress]");
	const tocLinks = Array.from(document.querySelectorAll("[data-toc-link]"));
	const tocPanel = document.querySelector("[data-toc-panel]");
	const tocToggle = document.querySelector("[data-toc-toggle]");
	const tocIcon = document.querySelector("[data-toc-icon]");

	const updateProgress = () => {
		const totalHeight =
			document.documentElement.scrollHeight - window.innerHeight;
		const progress =
			totalHeight > 0 ? (window.scrollY / totalHeight) * 100 : 0;
		if (progressBar) {
			progressBar.style.width = `${progress}%`;
		}
	};

	const setActiveLink = (id) => {
		tocLinks.forEach((link) => {
			const isActive = link.dataset.tocLink === id;
			link.classList.toggle("text-brand-cyan", isActive);
			link.classList.toggle("font-bold", isActive);
		});
	};

	const observer = new IntersectionObserver(
		(entries) => {
			entries.forEach((entry) => {
				if (entry.isIntersecting) {
					setActiveLink(entry.target.id);
				}
			});
		},
		{rootMargin: "-100px 0px -60% 0px"}
	);

	tocLinks.forEach((link) => {
		const id = link.dataset.tocLink;
		if (!id) return;
		const target = document.getElementById(id);
		if (target) observer.observe(target);
		link.addEventListener("click", () => {
			if (target) {
				target.scrollIntoView({behavior: "smooth"});
			}
			if (tocPanel) {
				tocPanel.classList.add("hidden");
			}
		});
	});

	if (tocToggle && tocPanel && tocIcon) {
		tocToggle.addEventListener("click", () => {
			const isOpen = tocPanel.classList.toggle("hidden") === false;
			tocIcon.innerHTML = isOpen
				? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6" /></svg>'
				: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6" /></svg>';
		});
	}

	updateProgress();
	window.addEventListener("scroll", updateProgress, {passive: true});
</script>
